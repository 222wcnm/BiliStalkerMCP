# BiliStalkerMCP - Gemini 工作台

本文档是为 AI 助手提供的核心上下文，用于记录项目的关键信息、开发准则和任务规划。

---

## 1. 核心开发准则 (来自 .clinerules)

- **用户焦点**: 功能严格限定于获取 **特定B站用户** 的深度数据画像。
- **只读操作**: 所有工具 **严禁** 任何写入或修改操作（如点赞、评论）。
- **数据时效**: 致力于提供新鲜、准确的数据。
- **图文动态解析**: `core.py` 中有对图文动态的特殊解析逻辑，修改时必须谨慎并进行回归测试。

---

## 2. 历史会话总结 (截至 2025/09/14)

### 2.1. 主要批评 (来自 AI 锐评)

- **安全风险**: 项目直接暴露用户 Cookie，是最大的安全隐患。
- **架构耦合**: `cli.py` 和 `core.py` 逻辑耦合严重，是“幼稚的模块化”。
- **健壮性差**: 异常处理过于宽泛；缓存没有设置过期时间。

### 2.2. 已完成的优化任务

- **[x] 增强健壮性**: 为缓存增加了 TTL；实现了更精确的异常捕获。
- **[x] 代码重构**: 使用 `@precheck` 装饰器消除了 `cli.py` 中的重复验证代码。
- **[x] 功能扩展**: 为所有获取列表的工具添加了分页功能 (`page` / `offset`)。
- **[x] Bug修复**: 清理了 `core.py` 中因复制粘贴产生的重复函数。

---

## 3. 下一阶段任务：架构重构与功能新增

**核心目标**: 解决架构耦合问题，实现清晰分层，并在此基础上新增“搜索用户”功能，确保项目符合 FastMCP 最佳实践。

### 3.1. 实施方案：先重构，后新增

#### **第一阶段：核心架构重构**

1.  **创建目录结构**:
    *   创建 `bili_stalker_mcp/models`, `bili_stalker_mcp/api_client`, 和 `bili_stalker_mcp/services` 目录。

2.  **数据建模 (`models`)**:
    *   在 `models/` 目录下，使用 Pydantic 为 `User`, `Video`, `Dynamic` 等核心对象创建强类型的数据模型。

3.  **API客户端层 (`api_client`)**:
    *   将 `core.py` 中所有直接与 Bilibili API 交互的 `fetch_*` 函数剥离并迁移到 `api_client/` 模块下，使其只负责原始数据请求。

4.  **服务层 (`services`)**:
    *   在 `services/` 目录下创建服务层（如 `user_service.py`），用于处理业务逻辑、缓存、以及用户名到UID的转换等。

5.  **简化工具入口 (`cli.py`)**:
    *   重构 `cli.py`，使其只负责定义 MCP 工具（`@mcp.tool`），并将所有实现委托给服务层。

#### **第二阶段：新增“搜索用户”工具**

1.  **API层 (`api_client`)**:
    *   在 `api_client` 中添加调用 Bilibili 用户搜索接口的新函数。

2.  **服务层 (`services`)**:
    *   在 `user_service.py` 中添加 `search_users(...)` 方法，负责调用 API、处理分页并将结果转换为 Pydantic 模型。

3.  **工具层 (`cli.py`)**:
    *   在 `cli.py` 中注册新的 `search_users` 工具，使其对 AI 模型可用。

### 3.2. 任务清单 (Todo List)

-   [ ] **阶段一：架构重构**
    -   [ ] 创建 `models`, `api_client`, `services` 目录。
    -   [ ] 使用 Pydantic 在 `models/` 中定义数据模型。
    -   [ ] 将 `core.py` 的 API 调用逻辑迁移到 `api_client/`。
    -   [ ] 在 `services/` 中创建服务层并实现业务逻辑。
    -   [ ] 重构 `cli.py`，使其调用服务层。
-   [ ] **阶段二：新增功能**
    -   [ ] 在 `api_client` 中实现用户搜索的 API 调用。
    -   [ ] 在 `services` 中添加 `search_users` 服务。
    -   [ ] 在 `cli.py` 中注册 `search_users` 新工具。
-   [ ] **阶段三：验证**
    -   [ ] 更新 `tests/` 目录下的测试用例以适应新架构。
    -   [ ] 确保所有工具在新架构下正常工作。
