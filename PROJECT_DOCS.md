# BiliStalkerMCP 项目文档

> **版本**: v2.3  
> **更新时间**: 2025-01-19  
> **项目状态**: 正在持续改进  

---

## 目录

1. [项目概述](#项目概述)
2. [功能特性](#功能特性)
3. [技术架构](#技术架构)
4. [已解决问题](#已解决问题)
5. [当前问题](#当前问题)
6. [改进规划](#改进规划)
7. [开发规范](#开发规范)

---

## 项目概述

### 基本信息
- **项目名称**: BiliStalkerMCP
- **项目描述**: 基于 Model Context Protocol (MCP) 的 Bilibili 用户数据获取服务
- **目标用户**: AI模型开发者、Bilibili数据分析人员、内容创作者
- **核心价值**: 提供标准化方式，使AI模型能够实时获取Bilibili用户的深度数据画像

### 设计原则
- **用户焦点**: 功能严格限定于获取特定B站用户的深度数据画像
- **只读操作**: 所有工具严禁任何写入或修改操作（如点赞、评论）
- **数据时效**: 致力于提供新鲜、准确的数据
- **安全第一**: 确保用户认证信息安全

---

## 功能特性

### 核心工具 (MCP Tools)

#### 1. 用户基础信息 (`get_user_info`)
- **功能**: 获取用户的基础个人信息和关系数据
- **参数**: `user_id` (int) 或 `username` (str)
- **返回数据**: 用户ID、昵称、头像、签名、等级、粉丝数、关注数等

#### 2. 视频投稿 (`get_user_video_updates`)
- **功能**: 获取用户发布的视频列表，包含详细字幕信息
- **参数**: `user_id`/`username`, `page`, `limit` (1-50)
- **特色功能**: 
  - 自动从AID转换生成BVID
  - 增强字幕信息（多语言、AI生成检测）
  - 字幕下载URL提供

#### 3. 动态内容 (`get_user_dynamic_updates`)
- **功能**: 获取用户的动态列表，支持类型筛选
- **参数**: `user_id`/`username`, `offset`, `limit`, `dynamic_type`
- **支持类型**: ALL、VIDEO、DRAW、ARTICLE、ANIME
- **特色**: 智能解析不同动态类型，统一数据结构

#### 4. 专栏文章 (`get_user_articles`)
- **功能**: 获取用户发布的专栏文章列表
- **参数**: `user_id`/`username`, `page`, `limit`
- **返回数据**: 文章ID、标题、摘要、封面、发布时间、统计数据

#### 5. 关注列表 (`get_user_followings`)
- **功能**: 获取用户的关注列表
- **参数**: `user_id`/`username`, `page`, `limit`
- **特色**: 自动检测用户隐私设置

### 技术特性
- ✅ **参数灵活性**: 支持用户ID和用户名两种输入方式
- ✅ **自动转换**: 用户名自动解析为用户ID
- ✅ **缓存机制**: LRU缓存提升性能
- ✅ **错误恢复**: 智能数据修复（如BVID缺失时自动生成）
- ✅ **类型安全**: 使用Pydantic进行参数验证

---

## 技术架构

### 技术栈
- **语言**: Python 3.10+
- **核心框架**: FastMCP (MCP协议实现)
- **API库**: bilibili-api-python 17.3.0+
- **HTTP客户端**: httpx
- **构建工具**: uv
- **部署方式**: uvx (魔搭社区托管)

### 项目结构
```
bili_stalker_mcp/
├── __init__.py          # 包初始化
├── cli.py              # 命令行接口和MCP工具定义
├── config.py           # 配置管理
├── core.py             # 核心业务逻辑
└── server.py           # MCP服务器和格式化函数
tests/
├── test_suite.py       # 主测试套件
└── ...                 # 其他测试文件
```

### 架构特点
- **模块化设计**: 分离配置、核心逻辑、服务器启动
- **分层架构**: CLI层 → 核心业务层 → 配置层
- **装饰器模式**: @precheck 装饰器统一处理前置检查

---

## 已解决问题

### 1. 时间戳转换问题 ✅
**问题**: 模型调用工具后时间戳转换错误，导致显示不正确或程序崩溃

**解决方案**:
- 创建统一的 `_format_timestamp()` 函数
- 增强异常处理，支持 None 值、无效时间戳
- 友好的错误提示（"未知时间"、"时间戳错误"）

**修复效果**:
- ✅ 不会因无效时间戳导致崩溃
- ✅ 提供一致的时间格式显示
- ✅ 保持向后兼容性

### 2. 参数验证和错误处理 ✅
**改进**:
- 使用Pydantic Field注解进行严格参数验证
- 详细的中文错误提示
- 区分不同类型的错误（用户不存在、API限流、隐私设置等）

### 3. 数据完整性问题 ✅
**解决**:
- BVID缺失时自动从AID转换生成
- 用户名自动解析为用户ID
- 缓存机制减少重复API调用

### 4. 动态解析复杂性 ✅
**改进**:
- 统一的动态数据结构
- 支持多种动态类型解析（视频、图文、专栏、转发等）
- 真正的服务端类型筛选

---

## 当前问题

### 1. 反爬虫机制挑战 🔴 [高优先级]
**问题描述**:
- 魔搭社区部署后遭遇HTTP 412错误
- 云端环境IP更容易被识别为机器请求
- 请求头可能过时，缺少最新的浏览器指纹

**影响范围**: 影响所有API调用的成功率

### 2. 架构耦合问题 🟡 [中优先级]
**问题描述**:
- `cli.py` 和 `core.py` 逻辑耦合严重
- 缺乏清晰的分层架构
- 代码复用性不足

**技术债务**: 影响代码维护性和扩展性

### 3. 性能优化需求 🟡 [中优先级]
**问题描述**:
- 请求延迟和重试机制会影响调用效率
- 缺乏智能的并发控制
- 缓存策略可进一步优化

### 4. 安全性提升需求 🟡 [中优先级]
**问题描述**:
- 直接暴露用户Cookie存在安全隐患
- 缺乏凭证轮换机制
- 需要更好的环境变量安全管理

---

## 改进规划

### 第一阶段：反爬虫机制优化 [当前进行中]

#### 已完成 ✅
- [x] 升级 bilibili-api-python 到 17.3.0
- [x] 更新项目版本到 2.3

#### 进行中 🚧
- [ ] 实现请求头轮换机制
- [ ] 增加智能延迟和重试策略
- [ ] 添加指数退避重试机制

#### 计划实施
- [ ] 集成代理支持
- [ ] 实现请求频率自适应调整
- [ ] 添加请求成功率监控

### 第二阶段：架构重构 [计划中]

#### 目标架构
```
bili_stalker_mcp/
├── models/              # 数据模型层
│   ├── user.py         # 用户相关模型
│   ├── video.py        # 视频相关模型
│   └── dynamic.py      # 动态相关模型
├── api_client/          # API客户端层
│   ├── base.py         # 基础客户端
│   └── bilibili.py     # Bilibili API客户端
├── services/            # 业务服务层
│   ├── user_service.py # 用户服务
│   └── cache_service.py # 缓存服务
├── tools/               # MCP工具定义
│   └── user_tools.py   # 用户相关工具
└── core/                # 核心基础设施
    ├── config.py       # 配置管理
    └── exceptions.py   # 异常定义
```

#### 重构计划
1. **数据建模**: 使用Pydantic创建强类型数据模型
2. **API层分离**: 将API调用逻辑独立到api_client模块
3. **服务层抽象**: 创建业务逻辑服务层
4. **工具层简化**: MCP工具只负责接口定义

### 第三阶段：功能扩展 [规划中]

#### 新功能开发
- [ ] 用户搜索工具 (search_users)
- [ ] 视频弹幕获取工具
- [ ] 用户粉丝列表工具
- [ ] 批量操作支持

#### 性能优化
- [ ] 智能并发控制
- [ ] 分布式缓存支持
- [ ] 请求队列管理
- [ ] 响应压缩优化

### 第四阶段：企业级特性 [长期规划]

#### 安全增强
- [ ] 凭证轮换机制
- [ ] 访问日志和审计
- [ ] 权限管理系统
- [ ] 安全扫描集成

#### 监控和运维
- [ ] 健康检查端点
- [ ] 性能指标收集
- [ ] 错误率监控
- [ ] 自动故障恢复

#### 扩展性提升
- [ ] 插件系统设计
- [ ] 多平台支持框架
- [ ] API版本管理
- [ ] 配置热更新

---

## 开发规范

### 代码规范
- **代码风格**: 使用 black 进行格式化
- **类型检查**: 使用 mypy 进行静态类型检查
- **导入排序**: 使用 isort 管理导入语句
- **错误处理**: 提供友好的中文错误信息

### 版本管理
- **语义化版本**: 遵循 SemVer 规范
- **Git标签**: 每个发布版本创建对应标签
- **变更日志**: 维护详细的版本变更记录

### 测试要求
- **单元测试**: 使用 pytest 框架
- **集成测试**: 验证MCP工具完整流程
- **性能测试**: 监控API响应时间
- **边界测试**: 验证异常情况处理

### 发布流程
1. **代码审查**: 确保代码质量
2. **测试验证**: 运行完整测试套件
3. **版本更新**: 更新版本号和文档
4. **构建打包**: 使用 uv 构建分发包
5. **PyPI发布**: 发布到Python包索引
6. **部署验证**: 在魔搭社区验证功能

---

## 结语

BiliStalkerMCP 项目致力于为AI模型提供高质量的Bilibili用户数据获取能力。我们将持续改进项目的稳定性、性能和安全性，同时保持良好的开发者体验。

欢迎社区贡献和反馈，让我们一起构建更好的数据服务！

---

**文档维护**: 本文档将随着项目发展持续更新  
**反馈渠道**: GitHub Issues  
**许可证**: MIT License  